@model View.ViewModel.CartVM
@{
    Layout = "_LayoutCustomer"; 
    ViewData["Title"] = "Shopping Cart";
    decimal? totalAmount = 0;
}
<section class="h-100 h-custom" style="background-color: #d2c9ff;">
    <div class="container py-5 h-100">
        <div class="row d-flex justify-content-between h-100">
            <!-- Shopping Cart -->
            <div class="col-lg-8">
                <div class="card card-registration" style="border-radius: 15px;">
                    <div class="card-body p-5">
                        <h1 class="fw-bold mb-4">Shopping Cart</h1>
                        <h6 class="mb-4 text-muted">@Model.CartDetails.Count() items</h6>
                        <hr class="my-4">

                        @foreach (var item in Model.CartDetails)
                        {
                            <div class="row mb-4 d-flex justify-content-between align-items-center">
                                <div class="col-md-1">
                                    <input class="form-check-input" type="checkbox" id="selectedProduct-@item.Id" value="@item.ProductDetailId" onchange="addToOrder()" />
                                </div>
                                <div class="col-md-2">
                                    <!-- Carousel Slide trong cột thứ hai (không có nút điều khiển) -->
                                    <div id="productCarousel" class="carousel slide" data-ride="carousel">
                                        <div class="carousel-inner border rounded shadow-sm">
                                            @foreach (var image in Model.ImagesForProduct.Where(i => i.ProductId == item.ProductDetail.ProductId).Where(i => i.ColorId == item.ProductDetail.ColorId).Select((value, index) => new { value, index }))
                                            {
                                                <div class="carousel-item @(image.index == 0 ? "active" : "")">
                                                    <img src="@Url.Content(image.value.URL)" alt="NotFound" style="width:100%; height:auto;">
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted">@item.ProductDetail.Product.Name</h6>
                                    <h6 class="mb-0">Price: @item.ProductDetail.Price VND</h6>  
                                </div>
                                <div class="col-md-2 d-flex">
                                    <button class="btn btn-link px-2" onclick="this.parentNode.querySelector('input[type=number]').stepDown()">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input id="quantity-@item.Id" min="0" name="quantity" value="@item.Quanlity" type="number" class="form-control form-control-sm" />
                                    <button class="btn btn-link px-2" onclick="this.parentNode.querySelector('input[type=number]').stepUp()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <h6 class="mb-0">@item.TotalPrice VND</h6>
                                </div>
                                <div class="col-md-1 text-end">
                                    @Html.ActionLink("Remove", "RemoveFromCart", new { id = item.Id }, new { @class = "text-muted" })
                                </div>
                            </div>
                            <hr class="my-4">
                            totalAmount += item.TotalPrice;
                        }

                        <div class="pt-4">
                            <h6><a href="@Url.Action("Index", "Products")" class="text-body"><i class="fas fa-long-arrow-alt-left me-2"></i>Back to shop</a></h6>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="col-lg-4">
                <form id="productForm" asp-action="CreateOrder" method="post">
                <div class="card bg-body-tertiary" style="border-radius: 15px;">
                    <div class="card-body p-5">
                        <h3 class="fw-bold mb-5 mt-2 pt-1">Summary</h3>
                        <hr class="my-4">
                        <div class="d-flex justify-content-between mb-4">
                            <h5 class="text-uppercase">Items @Model.CartDetails.Count()</h5>
                            <h5>@totalAmount VND</h5>
                        </div>

                        <h5 class="text-uppercase mb-3">Shipping</h5>
                        <div class="mb-4 pb-2">
                            <select class="form-select">
                                <option value="1">Standard Delivery - 5,000 VND</option>
                                <option value="2">Express Delivery - 10,000 VND</option>
                            </select>
                        </div>

                        <h5 class="text-uppercase mb-3">Promo Code</h5>
                        <div class="mb-5">
                            <input type="text" id="promoCode" class="form-control form-control-lg" placeholder="Enter your code" />
                        </div>

                        <hr class="my-4">
                        <div class="d-flex justify-content-between mb-5">
                            <h5 class="text-uppercase">Total Price</h5>
                            <h5>@(totalAmount + 5000) VND</h5>
                        </div>

                        <button type="submit" class="btn btn-dark btn-block btn-lg">Proceed to Checkout</button>
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>
</section>

@section Scripts{
    <script>
        let selectedProducts = [];

        function addToOrder() {
            const products = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .filter(checkbox => checkbox.id.startsWith(`selectedProduct`))
                .map(checkbox => ({
                    value: checkbox.value,
                    text: document.querySelector(`input[id="${checkbox.value}"]`).value
                }));

            selectedProducts = [];
            if (products.length == 0) { return; };

            
            products.forEach(p => {
                let quantity = document.getElementById(`quantity-${p.text}`);
                let totalPrice = document.getElementById(`totalPrice-${p.text}`);
                selectedProducts.push({
                    Id: p.text,
                    TotalPrice: totalPrice.value,
                    Quanlity: quantity.value,
                    ProductDetailId: p.value
                });
            });
            console.log(selectedProducts);
        }

        // Hàm xử lý submit form
        document.getElementById('productForm').addEventListener('submit', function (e) {
            e.preventDefault(); // Ngăn chặn submit mặc định

            if (selectedProducts === []) {
                alert('Vui lòng chọn sản phẩm để thanh toán!');
                e.preventDefault();
                return;
            }
            // Chuyển đổi danh sách biến thể thành JSON
            const selectedProductsJson = JSON.stringify(selectedProducts);

            // Tạo một input hidden để lưu JSON của chi tiết sản phẩm
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'selectedProductsJson'; // Tên phải khớp với bên controller
            hiddenInput.value = selectedProductsJson;

            // Gắn input ẩn vào form
            this.appendChild(hiddenInput);

            // Submit form
            this.submit();
            alert('Đơn hàng của bạn đã được tạo.');
        });
    </script>
}
